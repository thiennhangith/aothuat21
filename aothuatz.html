<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FFD700">
    <meta name="description" content="Trò ảo thuật 21 biểu tượng - Phép màu đọc vị tâm trí kỳ diệu">
    <title>Trò Ảo Thuật 21 Biểu Tượng - Phiên Bản Hoàn Hảo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gold: #FFD700;
            --secondary-gold: #FFA500;
            --dark-gold: #B8860B;
            --royal-purple: #6B46C1;
            --deep-purple: #4C1D95;
            --success-green: #10B981;
            --danger-red: #EF4444;
            --warning-orange: #F59E0B;
            --info-blue: #3B82F6;
            --bg-gradient: linear-gradient(135deg, #0F0C29 0%, #24243e 25%, #302B63 50%, #24243e 75%, #0F0C29 100%);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-hover: rgba(255, 255, 255, 0.12);
            --shadow-light: rgba(255, 255, 255, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.3);
            
            /* Responsive breakpoints */
            --mobile-s: 320px;
            --mobile-m: 375px;
            --mobile-l: 425px;
            --tablet: 768px;
            --laptop: 1024px;
            --laptop-l: 1440px;
            --desktop: 2560px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *::before,
        *::after {
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Be Vietnam Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            color: white;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Enhanced Animated Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -3;
            background: var(--bg-gradient);
        }

        .animated-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 25% 25%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 25%, rgba(107, 70, 193, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 25% 75%, rgba(255, 165, 0, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(76, 29, 149, 0.08) 0%, transparent 50%);
            animation: bgPulse 12s ease-in-out infinite alternate;
        }

        .animated-bg::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 48%, rgba(255, 215, 0, 0.02) 49%, rgba(255, 215, 0, 0.02) 51%, transparent 52%);
            animation: bgShine 8s ease-in-out infinite;
        }

        @keyframes bgPulse {
            0% { opacity: 0.4; transform: scale(1) rotate(0deg); }
            100% { opacity: 0.8; transform: scale(1.05) rotate(2deg); }
        }

        @keyframes bgShine {
            0%, 100% { transform: translateX(-100%) translateY(-100%); }
            50% { transform: translateX(100%) translateY(100%); }
        }

        /* Enhanced Particle System */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -2;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.7;
            animation: particleFloat 15s ease-in-out infinite;
            will-change: transform, opacity;
        }

        .particle.gold {
            background: radial-gradient(circle, var(--primary-gold), var(--secondary-gold));
            width: 8px;
            height: 8px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }

        .particle.purple {
            background: radial-gradient(circle, var(--royal-purple), var(--deep-purple));
            width: 6px;
            height: 6px;
            box-shadow: 0 0 12px rgba(107, 70, 193, 0.6);
        }

        .particle.white {
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.6));
            width: 4px;
            height: 4px;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
        }

        @keyframes particleFloat {
            0%, 100% { 
                transform: translateY(0px) translateX(0px) rotate(0deg); 
                opacity: 0.7; 
            }
            25% { 
                transform: translateY(-50px) translateX(-20px) rotate(90deg); 
                opacity: 1; 
            }
            50% { 
                transform: translateY(-30px) translateX(30px) rotate(180deg); 
                opacity: 0.5; 
            }
            75% { 
                transform: translateY(-80px) translateX(-10px) rotate(270deg); 
                opacity: 1; 
            }
        }

        /* Enhanced Container với Responsive */
        .container {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            padding: clamp(15px, 4vw, 30px);
            position: relative;
            z-index: 1;
        }

        /* Enhanced Header */
        .header {
            text-align: center;
            margin-bottom: clamp(30px, 6vw, 60px);
            position: relative;
        }

        .main-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2rem, 6vw, 4.5rem);
            font-weight: 900;
            background: linear-gradient(45deg, 
                var(--primary-gold) 0%, 
                var(--secondary-gold) 20%, 
                var(--primary-gold) 40%, 
                var(--secondary-gold) 60%, 
                var(--primary-gold) 80%,
                var(--secondary-gold) 100%);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleFlow 6s ease-in-out infinite;
            text-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
            margin-bottom: 15px;
            position: relative;
            letter-spacing: clamp(1px, 0.5vw, 3px);
            line-height: 1.1;
        }

        @keyframes titleFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .main-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: clamp(150px, 30vw, 300px);
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary-gold), transparent);
            animation: underlineGlow 3s ease-in-out infinite alternate;
            border-radius: 2px;
        }

        @keyframes underlineGlow {
            0% { 
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
                transform: translateX(-50%) scaleX(0.8);
            }
            100% { 
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
                transform: translateX(-50%) scaleX(1.2);
            }
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: clamp(1rem, 3vw, 1.4rem);
            font-weight: 400;
            margin-bottom: 25px;
            animation: subtitleFloat 4s ease-in-out infinite alternate;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        @keyframes subtitleFloat {
            0% { transform: translateY(0px); opacity: 0.9; }
            100% { transform: translateY(-5px); opacity: 1; }
        }

        /* Enhanced Step Info Card */
        .step-info {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border-radius: clamp(20px, 4vw, 30px);
            padding: clamp(25px, 5vw, 45px);
            margin-bottom: clamp(30px, 6vw, 60px);
            border: 2px solid var(--glass-border);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 var(--shadow-light);
            position: relative;
            overflow: hidden;
            animation: cardSlideIn 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .step-info::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary-gold), var(--secondary-gold), var(--primary-gold), transparent);
            animation: borderFlow 4s ease-in-out infinite;
        }

        .step-info::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(255, 215, 0, 0.05) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .step-info:hover::after {
            opacity: 1;
        }

        @keyframes borderFlow {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes cardSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-30px) scale(0.95); 
                filter: blur(5px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
                filter: blur(0px);
            }
        }

        .step-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.4rem, 4vw, 2.4rem);
            color: var(--primary-gold);
            margin-bottom: 20px;
            font-weight: 700;
            text-shadow: 0 2px 15px rgba(255, 215, 0, 0.4);
            line-height: 1.2;
        }

        .step-description {
            color: rgba(255, 255, 255, 0.95);
            font-size: clamp(1rem, 2.5vw, 1.3rem);
            line-height: 1.8;
            font-weight: 400;
        }

        .warning-box {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.08));
            border: 2px solid var(--warning-orange);
            border-radius: clamp(15px, 3vw, 25px);
            padding: clamp(20px, 4vw, 30px);
            margin: clamp(20px, 4vw, 30px) 0;
            position: relative;
            animation: warningPulse 3s ease-in-out infinite;
        }

        @keyframes warningPulse {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 35px rgba(245, 158, 11, 0.6);
                transform: scale(1.01);
            }
        }

        .warning-title {
            font-weight: 700;
            color: var(--warning-orange);
            font-size: clamp(1.1rem, 3vw, 1.4rem);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Enhanced Symbol Card Styles với Perfect Responsive */
        .symbol-card {
            width: clamp(70px, 15vw, 95px);
            height: clamp(70px, 15vw, 95px);
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 0.98) 0%, 
                rgba(255, 255, 255, 0.88) 100%);
            border-radius: clamp(18px, 4vw, 25px);
            border: 3px solid rgba(255, 215, 0, 0.25);
            position: relative;
            display: inline-block;
            margin: clamp(6px, 2vw, 12px);
            cursor: pointer;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(2rem, 8vw, 3.2rem);
            backdrop-filter: blur(10px);
            transform-style: preserve-3d;
            will-change: transform;
        }

        .symbol-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.7) 50%, 
                transparent 100%);
            transition: left 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .symbol-card:hover::before {
            left: 100%;
        }

        .symbol-card:hover {
            transform: translateY(-12px) scale(1.08) rotateX(8deg);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.25),
                0 0 30px rgba(255, 215, 0, 0.5);
            border-color: var(--primary-gold);
            z-index: 10;
        }

        .symbol-card:active {
            transform: translateY(-8px) scale(1.05);
            transition: all 0.1s ease;
        }

        /* Enhanced Category Colors */
        .symbol-card.type-animal {
            background: linear-gradient(145deg, #FFF8DC 0%, #F0E68C 100%);
            color: #8B4513;
            border-color: rgba(139, 69, 19, 0.4);
        }

        .symbol-card.type-nature {
            background: linear-gradient(145deg, #F0FFF0 0%, #98FB98 100%);
            color: #228B22;
            border-color: rgba(34, 139, 34, 0.4);
        }

        .symbol-card.type-cosmic {
            background: linear-gradient(145deg, #191970 0%, #4169E1 100%);
            color: #FFD700;
            border-color: rgba(255, 215, 0, 0.5);
        }

        .symbol-card.type-food {
            background: linear-gradient(145deg, #FFE4E1 0%, #FFA07A 100%);
            color: #DC143C;
            border-color: rgba(220, 20, 60, 0.4);
        }

        .symbol-card.type-object {
            background: linear-gradient(145deg, #E6E6FA 0%, #D8BFD8 100%);
            color: #800080;
            border-color: rgba(128, 0, 128, 0.4);
        }

        .symbol-card.type-weather {
            background: linear-gradient(145deg, #F0F8FF 0%, #87CEEB 100%);
            color: #4682B4;
            border-color: rgba(70, 130, 180, 0.4);
        }

        .symbol-card.type-transport {
            background: linear-gradient(145deg, #FFF5EE 0%, #FFDAB9 100%);
            color: #FF4500;
            border-color: rgba(255, 69, 0, 0.4);
        }

        /* Perfect Responsive Grid */
        .initial-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(clamp(80px, 16vw, 110px), 1fr));
            gap: clamp(12px, 3vw, 25px);
            max-width: 1200px;
            margin: 0 auto;
            padding: clamp(25px, 5vw, 45px);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: clamp(25px, 5vw, 35px);
            border: 2px solid var(--glass-border);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .initial-cards::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 215, 0, 0.08), transparent);
            animation: cardGridRotate 15s linear infinite;
        }

        @keyframes cardGridRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Piles Display */
        .cards-display {
            display: flex;
            justify-content: center;
            gap: clamp(20px, 5vw, 60px);
            margin: clamp(30px, 6vw, 60px) 0;
            flex-wrap: wrap;
        }

        .card-pile {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border-radius: clamp(20px, 4vw, 30px);
            padding: clamp(20px, 4vw, 35px);
            min-width: clamp(280px, 45vw, 380px);
            max-width: 420px;
            border: 2px solid var(--glass-border);
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
            flex: 1;
        }

        .card-pile::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.15) 0%, transparent 60%);
            transform: scale(0);
            transition: transform 0.6s ease-out;
        }

        .card-pile:hover::before {
            transform: scale(1);
        }

        .card-pile:hover {
            transform: translateY(-10px) rotateX(3deg);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.25),
                0 0 40px rgba(255, 215, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.6);
            background: var(--glass-hover);
        }

        .card-pile.selected {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.25) 0%, 
                rgba(255, 165, 0, 0.15) 100%);
            border: 3px solid var(--primary-gold);
            box-shadow: 
                0 0 50px rgba(255, 215, 0, 0.7),
                0 20px 40px rgba(0, 0, 0, 0.3);
            transform: translateY(-10px) scale(1.02) rotateX(3deg);
        }

        .card-pile.selected::after {
            content: '✨ ĐÃ CHỌN ✨';
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gold);
            color: #1a1a1a;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: clamp(0.8rem, 2vw, 1rem);
            animation: selectedBadge 1s ease-out;
            white-space: nowrap;
        }

        @keyframes selectedBadge {
            0% { 
                opacity: 0; 
                transform: translateX(-50%) translateY(-10px) scale(0.8) rotate(-5deg); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(-50%) translateY(0) scale(1) rotate(0deg); 
            }
        }

        .pile-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.2rem, 3vw, 1.7rem);
            font-weight: 700;
            color: var(--primary-gold);
            margin-bottom: clamp(20px, 4vw, 30px);
            text-align: center;
            text-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .pile-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: clamp(50px, 15vw, 80px);
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-gold), transparent);
            border-radius: 1px;
        }

        .pile-cards {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: clamp(8px, 2vw, 15px);
            position: relative;
            z-index: 1;
        }

        /* Enhanced Buttons với Perfect Touch */
        .btn {
            font-family: 'Be Vietnam Pro', sans-serif;
            background: linear-gradient(145deg, var(--primary-gold) 0%, var(--secondary-gold) 100%);
            border: none;
            padding: clamp(15px, 4vw, 22px) clamp(30px, 6vw, 50px);
            border-radius: 50px;
            font-size: clamp(1rem, 3vw, 1.4rem);
            font-weight: 700;
            color: #1a1a1a;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin: clamp(10px, 3vw, 20px);
            box-shadow: 
                0 12px 30px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: clamp(1px, 0.3vw, 2px);
            transform-style: preserve-3d;
            min-height: 48px; /* Touch-friendly */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            border: 2px solid transparent;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.4) 50%, 
                transparent 100%);
            transition: left 0.6s ease-out;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 
                0 20px 40px rgba(255, 215, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            background: linear-gradient(145deg, var(--secondary-gold) 0%, var(--primary-gold) 100%);
        }

        .btn:active {
            transform: translateY(-3px) scale(0.98);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.3);
            transition: all 0.1s ease;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            background: linear-gradient(145deg, #999, #666);
        }

        .btn:disabled:hover {
            transform: none;
        }

        .btn:focus {
            outline: 3px solid rgba(255, 215, 0, 0.5);
            outline-offset: 2px;
        }

        /* Magic Reveal Section Enhanced */
        .magic-reveal {
            text-align: center;
            padding: clamp(50px, 8vw, 100px) clamp(25px, 5vw, 50px);
            background: radial-gradient(ellipse at center, 
                rgba(255, 215, 0, 0.12) 0%, 
                rgba(107, 70, 193, 0.08) 30%,
                rgba(76, 29, 149, 0.05) 60%,
                transparent 100%);
            border-radius: clamp(30px, 6vw, 50px);
            margin: clamp(40px, 8vw, 80px) 0;
            position: relative;
            overflow: hidden;
        }

        .magic-reveal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 30% 70%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(255, 165, 0, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(107, 70, 193, 0.06) 0%, transparent 50%);
            animation: magicAura 8s ease-in-out infinite alternate;
        }

        @keyframes magicAura {
            0% { 
                opacity: 0.4; 
                transform: scale(1) rotate(0deg); 
            }
            100% { 
                opacity: 0.9; 
                transform: scale(1.08) rotate(3deg); 
            }
        }

        .magic-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2rem, 5vw, 3.5rem);
            color: var(--primary-gold);
            margin-bottom: clamp(30px, 6vw, 50px);
            text-shadow: 
                0 0 30px rgba(255, 215, 0, 0.6),
                0 0 60px rgba(255, 215, 0, 0.3);
            animation: textMagicGlow 4s ease-in-out infinite alternate;
            position: relative;
            z-index: 1;
            line-height: 1.2;
        }

        @keyframes textMagicGlow {
            0% { 
                text-shadow: 
                    0 0 30px rgba(255, 215, 0, 0.6),
                    0 0 60px rgba(255, 215, 0, 0.3);
                transform: scale(1);
            }
            100% { 
                text-shadow: 
                    0 0 40px rgba(255, 215, 0, 0.9),
                    0 0 80px rgba(255, 215, 0, 0.5),
                    0 0 120px rgba(255, 215, 0, 0.2);
                transform: scale(1.02);
            }
        }

        /* Enhanced Loading Animation */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: clamp(10px, 3vw, 18px);
            margin: clamp(30px, 6vw, 50px) 0;
            position: relative;
            z-index: 1;
        }

        .loading-orb {
            width: clamp(16px, 4vw, 24px);
            height: clamp(16px, 4vw, 24px);
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary-gold), var(--secondary-gold));
            box-shadow: 
                0 0 20px rgba(255, 215, 0, 0.6),
                0 0 40px rgba(255, 215, 0, 0.3);
            animation: loadingPulse 2.5s ease-in-out infinite;
        }

        .loading-orb:nth-child(1) { animation-delay: 0s; }
        .loading-orb:nth-child(2) { animation-delay: 0.3s; }
        .loading-orb:nth-child(3) { animation-delay: 0.6s; }
        .loading-orb:nth-child(4) { animation-delay: 0.9s; }

        @keyframes loadingPulse {
            0%, 100% { 
                transform: scale(0.6) rotate(0deg); 
                opacity: 0.5; 
                background: radial-gradient(circle, var(--primary-gold), var(--secondary-gold));
            }
            50% { 
                transform: scale(1.4) rotate(180deg); 
                opacity: 1; 
                background: radial-gradient(circle, var(--secondary-gold), var(--primary-gold));
                box-shadow: 
                    0 0 30px rgba(255, 215, 0, 0.8),
                    0 0 60px rgba(255, 215, 0, 0.4);
            }
        }

        /* Final Reveal Enhanced */
        .final-reveal {
            text-align: center;
            padding: clamp(40px, 8vw, 70px);
            background: var(--glass-bg);
            backdrop-filter: blur(30px);
            border-radius: clamp(30px, 6vw, 50px);
            border: 3px solid var(--primary-gold);
            box-shadow: 
                0 0 80px rgba(255, 215, 0, 0.5),
                0 25px 50px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .final-reveal::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                from 0deg,
                transparent,
                rgba(255, 215, 0, 0.12),
                transparent,
                rgba(255, 165, 0, 0.1),
                transparent
            );
            animation: finalRevealRotate 12s linear infinite;
        }

        @keyframes finalRevealRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .reveal-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2rem, 5vw, 3.2rem);
            color: var(--primary-gold);
            margin-bottom: clamp(40px, 6vw, 60px);
            animation: revealTitleGlow 3s ease-in-out infinite alternate;
            position: relative;
            z-index: 1;
            line-height: 1.2;
        }

        @keyframes revealTitleGlow {
            0% { 
                text-shadow: 
                    0 0 30px rgba(255, 215, 0, 0.6),
                    0 0 60px rgba(255, 215, 0, 0.3);
                transform: scale(1);
            }
            100% { 
                text-shadow: 
                    0 0 50px rgba(255, 215, 0, 0.9),
                    0 0 100px rgba(255, 215, 0, 0.5),
                    0 0 150px rgba(255, 215, 0, 0.2);
                transform: scale(1.02);
            }
        }

        .revealed-symbol {
            width: clamp(140px, 30vw, 200px);
            height: clamp(140px, 30vw, 200px);
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: clamp(25px, 6vw, 40px);
            border: clamp(4px, 1vw, 6px) solid var(--primary-gold);
            margin: clamp(30px, 6vw, 50px) auto;
            position: relative;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.3),
                0 0 60px rgba(255, 215, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            animation: symbolMagicReveal 3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(4rem, 12vw, 6rem);
            z-index: 1;
        }

        @keyframes symbolMagicReveal {
            0% { 
                opacity: 0; 
                transform: rotateY(180deg) scale(0.3) rotateX(45deg); 
                filter: blur(10px);
            }
            25% {
                opacity: 0.4;
                transform: rotateY(135deg) scale(0.6) rotateX(30deg);
                filter: blur(5px);
            }
            50% {
                opacity: 0.7;
                transform: rotateY(90deg) scale(0.8) rotateX(15deg);
                filter: blur(2px);
            }
            75% {
                opacity: 0.9;
                transform: rotateY(45deg) scale(1.1) rotateX(-5deg);
                filter: blur(1px);
            }
            100% { 
                opacity: 1; 
                transform: rotateY(0deg) scale(1) rotateX(0deg); 
                filter: blur(0px);
            }
        }

        .revealed-symbol::before {
            content: '';
            position: absolute;
            top: -150%;
            left: -150%;
            width: 400%;
            height: 400%;
            background: linear-gradient(45deg, 
                transparent 20%, 
                rgba(255, 215, 0, 0.4) 40%,
                rgba(255, 255, 255, 0.6) 50%,
                rgba(255, 215, 0, 0.4) 60%,
                transparent 80%);
            animation: symbolShine 6s ease-in-out infinite;
        }

        @keyframes symbolShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            20% { transform: translateX(-50%) translateY(-50%) rotate(45deg); }
            40% { transform: translateX(0%) translateY(0%) rotate(45deg); }
            60% { transform: translateX(50%) translateY(50%) rotate(45deg); }
            80% { transform: translateX(100%) translateY(100%) rotate(45deg); }
            100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        }

        /* Enhanced Debug Panel */
        .debug-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: clamp(11px, 2vw, 13px);
            z-index: 3000;
            display: none;
            border: 2px solid var(--primary-gold);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            max-width: min(300px, 90vw);
            max-height: 80vh;
            overflow-y: auto;
        }

        .debug-panel.show {
            display: block;
            animation: debugSlide 0.5s ease-out;
        }

        @keyframes debugSlide {
            from { 
                opacity: 0; 
                transform: translateX(100%) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0) scale(1); 
            }
        }

        .debug-line {
            margin: 6px 0;
            padding: 3px 0;
            word-break: break-all;
            line-height: 1.4;
        }

        .debug-label {
            color: var(--primary-gold);
            font-weight: bold;
        }

        /* Accessibility & Touch Improvements */
        @media (hover: none) and (pointer: coarse) {
            .symbol-card:hover {
                transform: none;
            }
            
            .symbol-card:active {
                transform: translateY(-8px) scale(1.05);
            }
            
            .card-pile:hover {
                transform: none;
            }
            
            .card-pile:active {
                transform: translateY(-5px);
            }
            
            .btn:hover {
                transform: none;
            }
            
            .btn:active {
                transform: scale(0.95);
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeInUp 1.2s ease-out;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(50px) scale(0.95); 
                filter: blur(5px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
                filter: blur(0px);
            }
        }

        /* Sparkle Effects Enhanced */
        .sparkle {
            position: absolute;
            width: clamp(8px, 2vw, 12px);
            height: clamp(8px, 2vw, 12px);
            background: radial-gradient(circle, var(--primary-gold), var(--secondary-gold));
            border-radius: 50%;
            animation: sparkleFloat 5s ease-in-out infinite;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            will-change: transform, opacity;
        }

        @keyframes sparkleFloat {
            0%, 100% { 
                opacity: 0; 
                transform: translateY(0px) scale(0) rotate(0deg); 
            }
            25% { 
                opacity: 0.8; 
                transform: translateY(-25px) scale(0.8) rotate(90deg); 
            }
            50% { 
                opacity: 1; 
                transform: translateY(-50px) scale(1.2) rotate(180deg); 
            }
            75% { 
                opacity: 0.8; 
                transform: translateY(-75px) scale(0.8) rotate(270deg); 
            }
        }

        /* Perfect Responsive Breakpoints */
        
        /* Extra Small Mobile (320px and up) */
        @media screen and (max-width: 374px) {
            .container {
                padding: 12px;
            }
            
            .initial-cards {
                grid-template-columns: repeat(auto-fit, minmax(65px, 1fr));
                gap: 8px;
                padding: 15px;
            }
            
            .card-pile {
                min-width: 260px;
                padding: 15px;
            }
            
            .cards-display {
                gap: 15px;
            }
        }

        /* Small Mobile (375px and up) */
        @media screen and (min-width: 375px) and (max-width: 424px) {
            .initial-cards {
                grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
                gap: 10px;
            }
            
            .card-pile {
                min-width: 280px;
            }
        }

        /* Large Mobile (425px and up) */
        @media screen and (min-width: 425px) and (max-width: 767px) {
            .initial-cards {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: 12px;
            }
            
            .cards-display {
                flex-direction: column;
                align-items: center;
            }
            
            .card-pile {
                min-width: 320px;
                max-width: 400px;
                width: 100%;
            }
        }

        /* Tablet (768px and up) */
        @media screen and (min-width: 768px) and (max-width: 1023px) {
            .initial-cards {
                grid-template-columns: repeat(auto-fit, minmax(85px, 1fr));
                gap: 15px;
            }
            
            .cards-display {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .card-pile {
                min-width: 300px;
                flex: 1;
                max-width: 350px;
            }
        }

        /* Small Laptop (1024px and up) */
        @media screen and (min-width: 1024px) and (max-width: 1439px) {
            .cards-display {
                flex-wrap: nowrap;
            }
            
            .card-pile {
                min-width: 320px;
                flex: 1;
            }
        }

        /* Large Laptop (1440px and up) */
        @media screen and (min-width: 1440px) and (max-width: 2559px) {
            .card-pile {
                min-width: 360px;
            }
            
            .initial-cards {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
        }

        /* Desktop 4K (2560px and up) */
        @media screen and (min-width: 2560px) {
            .container {
                max-width: 2000px;
            }
            
            .card-pile {
                min-width: 400px;
            }
            
            .initial-cards {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 30px;
            }
        }

        /* Landscape Orientation for Mobile */
        @media screen and (max-width: 926px) and (orientation: landscape) {
            .main-title {
                font-size: clamp(1.8rem, 4vw, 2.5rem);
            }
            
            .header {
                margin-bottom: 30px;
            }
            
            .step-info {
                padding: 20px;
                margin-bottom: 30px;
            }
            
            .initial-cards {
                padding: 20px;
            }
            
            .magic-reveal {
                padding: 40px 20px;
            }
        }

        /* High DPI Displays */
        @media screen and (-webkit-min-device-pixel-ratio: 2),
               screen and (min-resolution: 192dpi) {
            .symbol-card {
                border-width: 2px;
            }
            
            .card-pile {
                border-width: 1px;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --glass-bg: rgba(255, 255, 255, 0.05);
                --glass-border: rgba(255, 255, 255, 0.1);
                --glass-hover: rgba(255, 255, 255, 0.08);
            }
        }

        /* Print Styles */
        @media print {
            .particles,
            .animated-bg,
            .debug-panel {
                display: none !important;
            }
            
            .container {
                padding: 0;
            }
            
            .step-info,
            .card-pile,
            .initial-cards {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Enhanced Background -->
    <div class="animated-bg" aria-hidden="true"></div>
    
    <!-- Enhanced Debug Panel -->
    <div class="debug-panel" id="debug-panel" role="complementary" aria-label="Debug Information">
        <div class="debug-line"><span class="debug-label">ROUND:</span> <span id="debug-round">0</span></div>
        <div class="debug-line"><span class="debug-label">SELECTED:</span> <span id="debug-selected">[]</span></div>
        <div class="debug-line"><span class="debug-label">MAGIC POS:</span> <span id="debug-position">10</span></div>
        <div class="debug-line"><span class="debug-label">LOGIC CARDS:</span> <span id="debug-logic">[]</span></div>
        <div class="debug-line"><span class="debug-label">PILE 0:</span> <span id="debug-pile0">[]</span></div>
        <div class="debug-line"><span class="debug-label">PILE 1:</span> <span id="debug-pile1">[]</span></div>
        <div class="debug-line"><span class="debug-label">PILE 2:</span> <span id="debug-pile2">[]</span></div>
    </div>

    <!-- Enhanced Particle Background -->
    <div class="particles" id="particles" aria-hidden="true"></div>
    
    <div class="container">
        <!-- Enhanced Header -->
        <header class="header">
            <h1 class="main-title">✨ MYSTICAL SYMBOL MAGIC ✨</h1>
            <p class="subtitle">Trải nghiệm phép màu thần kỳ đọc vị tâm trí với 21 biểu tượng kỳ diệu</p>
            <button onclick="toggleDebug()" 
                    style="background: none; border: none; color: rgba(255,255,255,0.3); font-size: 11px; cursor: pointer; padding: 8px; border-radius: 4px;"
                    aria-label="Toggle Debug Mode">Debug</button>
        </header>

        <!-- Enhanced Step Information -->
        <section id="step-info" class="step-info fade-in" role="main" aria-live="polite">
            <h2 class="step-title">🎯 Bước 1: Chọn Biểu Tượng Bí Mật Trong Tâm Trí</h2>
            <div class="step-description">
                <p>Nhìn vào 21 biểu tượng đẹp mắt dưới đây và <strong>chỉ ghi nhớ MỘT BIỂU TƯỢNG trong tâm trí</strong> của bạn. 
                Hãy chọn một biểu tượng mà bạn thực sự ấn tượng và <strong>tuyệt đối không được nói ra hay click chọn!</strong></p>
                
                <div class="warning-box" role="alert">
                    <div class="warning-title">⚠️ LƯU Ý CỰC KỲ QUAN TRỌNG</div>
                    <p><strong>KHÔNG ĐƯỢC CLICK VÀO BIỂU TƯỢNG!</strong><br>
                    Chỉ nhìn, ghi nhớ trong đầu, sau đó bấm nút "Bắt Đầu Phép Màu".<br>
                    Việc click sẽ làm hỏng phép màu! 🎭</p>
                </div>
                
                <p>💫 <em>Khi đã chọn xong biểu tượng trong tâm trí, hãy bấm nút bên dưới để bắt đầu phép màu...</em></p>
            </div>
        </section>

        <!-- Enhanced Initial Symbols Display -->
        <div id="initial-cards" class="initial-cards" role="presentation" aria-label="21 biểu tượng để lựa chọn"></div>

        <!-- Enhanced Symbol Piles Display -->
        <section id="piles-container" class="hidden" role="main" aria-live="polite">
            <div class="cards-display" id="piles-display" role="group" aria-label="Ba cọc biểu tượng"></div>
        </section>

        <!-- Enhanced Magic Reveal Section -->
        <section id="magic-reveal" class="magic-reveal hidden" role="main" aria-live="assertive">
            <h2 class="magic-title">🔮 Đang Đọc Vị Tâm Trí Bạn... 🔮</h2>
            <div class="loading-container" role="presentation" aria-label="Đang tải">
                <div class="loading-orb" aria-hidden="true"></div>
                <div class="loading-orb" aria-hidden="true"></div>
                <div class="loading-orb" aria-hidden="true"></div>
                <div class="loading-orb" aria-hidden="true"></div>
            </div>
            <p>Những biểu tượng thần bí đang thì thầm bí mật trong tâm trí bạn...<br>
            <em>Phép màu sắp hoàn thành...</em></p>
        </section>

        <!-- Enhanced Final Reveal -->
        <section id="final-reveal" class="final-reveal hidden" role="main" aria-live="assertive">
            <h2 class="reveal-title">🌟 Biểu Tượng Trong Tâm Trí Bạn Là:</h2>
            <div id="revealed-symbol" class="revealed-symbol" role="presentation" aria-label="Biểu tượng được tiết lộ"></div>
            <p><strong>✨ Phép màu đã hoàn thành hoàn hảo! ✨</strong><br>
            <em>Tôi đã đọc được chính xác suy nghĩ của bạn!</em></p>
            <button class="btn" onclick="restartGame()" aria-label="Chơi lại trò ảo thuật">🎲 Thử Phép Màu Mới</button>
        </section>

        <!-- Enhanced Control Buttons -->
        <div style="text-align: center; margin: clamp(30px, 6vw, 60px) 0;" role="navigation" aria-label="Điều khiển trò chơi">
            <button id="start-btn" class="btn" onclick="startGame()" aria-label="Bắt đầu trò ảo thuật">🚀 Bắt Đầu Phép Màu</button>
            <button id="next-btn" class="btn hidden" onclick="nextRound()" disabled aria-label="Tiếp tục đến bước tiếp theo">➡️ Tiếp Theo</button>
            <button id="reveal-btn" class="btn hidden" onclick="performMagic()" aria-label="Tiết lộ kết quả phép màu">✨ Tiết Lộ Phép Màu!</button>
        </div>
    </div>

    <script>
        // Perfect Magic Trick Implementation với Logic 100% Chính Xác
        class PerfectMagicTrick {
            constructor() {
                this.cards = []; // Thứ tự logic chính xác cho tính toán
                this.currentRound = 0;
                this.selectedPiles = [];
                this.isAnimating = false;
                this.DEBUG = false;
                this.currentLogicalPiles = null;
                
                // Enhanced symbol categories với emoji đẹp và dễ phân biệt
                this.symbolCategories = {
                    animals: ['🦁', '🦅', '🐺', '🦋', '🐸', '🐯', '🦊'],
                    nature: ['🌸', '🌙', '⭐', '🌈', '🍀', '🌺', '🌿'],
                    cosmic: ['🔮', '💎', '⚡', '🌟', '✨', '💫', '🌀'],
                    food: ['🍎', '🍓', '🥕', '🌽', '🍄', '🍊', '🥝'],
                    objects: ['🎪', '🎭', '🎨', '🏆', '🎯', '🎪', '🎸'],
                    weather: ['☀️', '❄️', '🌊', '🔥', '💨', '⛈️', '🌤️'],
                    transport: ['🚀', '⛵', '🎈', '🏰', '🎡', '✈️', '🚁']
                };
                
                this.init();
            }

            init() {
                this.createEnhancedParticles();
                this.generateCards();
                this.displayInitialCards();
                this.addEnhancedEventListeners();
                this.addMouseTracker();
                this.addTouchSupport();
                this.updateDebugPanel();
                
                // Performance optimization
                this.setupIntersectionObserver();
                this.preloadAssets();
            }

            createEnhancedParticles() {
                const particlesContainer = document.getElementById('particles');
                const particleCount = this.getOptimalParticleCount();
                const particleTypes = ['gold', 'purple', 'white'];

                // Clear existing particles
                particlesContainer.innerHTML = '';

                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    const type = particleTypes[i % particleTypes.length];
                    particle.className = `particle ${type}`;
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 15 + 's';
                    particle.style.animationDuration = (Math.random() * 8 + 10) + 's';
                    particlesContainer.appendChild(particle);
                }
            }

            getOptimalParticleCount() {
                // Optimize particle count based on device performance
                const width = window.innerWidth;
                const height = window.innerHeight;
                const area = width * height;
                const density = area / 30000; // particles per 30k pixels
                
                if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    return Math.min(5, Math.floor(density));
                }
                
                return Math.min(40, Math.max(15, Math.floor(density)));
            }

            generateCards() {
                this.cards = [];
                const categories = Object.keys(this.symbolCategories);
                
                // Generate exactly 21 unique symbols theo thứ tự logic
                for (let i = 0; i < 21; i++) {
                    const categoryIndex = i % categories.length;
                    const category = categories[categoryIndex];
                    const categorySymbols = this.symbolCategories[category];
                    const symbolInCategory = Math.floor(i / categories.length) % categorySymbols.length;
                    
                    this.cards.push({
                        symbol: categorySymbols[symbolInCategory],
                        category: category,
                        id: i,
                        logicalPosition: i
                    });
                }

                this.updateDebugPanel();
            }

            createSymbolElement(symbol, index = 0) {
                const symbolElement = document.createElement('div');
                symbolElement.className = `symbol-card type-${symbol.category} fade-in`;
                symbolElement.style.animationDelay = `${index * 0.06}s`;
                symbolElement.textContent = symbol.symbol;
                symbolElement.setAttribute('data-symbol-id', symbol.id);
                symbolElement.setAttribute('role', 'presentation');
                symbolElement.setAttribute('aria-label', `Biểu tượng ${symbol.symbol}`);
                
                // Add touch feedback
                symbolElement.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
                symbolElement.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: true });
                
                return symbolElement;
            }

            handleTouchStart(e) {
                e.currentTarget.style.transform = 'translateY(-8px) scale(1.05)';
            }

            handleTouchEnd(e) {
                e.currentTarget.style.transform = '';
            }

            displayInitialCards() {
                const container = document.getElementById('initial-cards');
                container.innerHTML = '';
                
                // Tạo một bản copy để shuffle cho hiển thị
                const displayCards = [...this.cards];
                
                // Shuffle chỉ để hiển thị, không ảnh hưởng logic
                this.shuffleArray(displayCards);
                
                displayCards.forEach((symbol, index) => {
                    const symbolElement = this.createSymbolElement(symbol, index);
                    container.appendChild(symbolElement);
                });
                
                // Announce to screen readers
                this.announceToScreenReader('21 biểu tượng đã được hiển thị. Hãy ghi nhớ một biểu tượng trong tâm trí.');
            }

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            startGame() {
                if (this.isAnimating) return;
                this.isAnimating = true;

                document.getElementById('start-btn').classList.add('hidden');
                document.getElementById('next-btn').classList.remove('hidden');
                
                this.updateStepInfo(
                    `🎯 Bước ${2 + this.currentRound}: Tìm Biểu Tượng Của Bạn`,
                    `Quan sát 3 cọc biểu tượng dưới đây và <strong>CLICK VÀO CỌC</strong> có chứa biểu tượng bạn đã ghi nhớ. 
                    <strong style="color: var(--warning-orange);">(Lần ${this.currentRound + 1}/3)</strong>`
                );
                
                setTimeout(() => {
                    this.dividIntoThreePiles();
                    document.getElementById('initial-cards').classList.add('hidden');
                    document.getElementById('piles-container').classList.remove('hidden');
                    this.isAnimating = false;
                    
                    this.announceToScreenReader(`Bước ${2 + this.currentRound}: Hãy chọn cọc có chứa biểu tượng của bạn.`);
                }, 600);
            }

            dividIntoThreePiles() {
                // LOGIC CHÍNH XÁC: Chia theo thứ tự đúng
                const logicalPiles = [[], [], []];
                
                this.cards.forEach((card, index) => {
                    logicalPiles[index % 3].push(card);
                });
                
                // TẠO DISPLAY PILES: Chỉ shuffle TRONG từng pile để che quy luật
                const displayPiles = logicalPiles.map(pile => {
                    const shuffledPile = [...pile];
                    this.shuffleArray(shuffledPile); // Shuffle nội bộ từng pile
                    return shuffledPile;
                });
                
                this.displayPiles(displayPiles);
                this.currentLogicalPiles = logicalPiles; // Lưu thứ tự logic để tính toán
                this.updateDebugPanel();
            }

            displayPiles(piles) {
                const container = document.getElementById('piles-display');
                container.innerHTML = '';
                
                piles.forEach((pile, pileIndex) => {
                    const pileElement = document.createElement('div');
                    pileElement.className = 'card-pile fade-in';
                    pileElement.style.animationDelay = `${pileIndex * 0.25}s`;
                    pileElement.onclick = () => this.selectPile(pileIndex);
                    pileElement.setAttribute('role', 'button');
                    pileElement.setAttribute('tabindex', '0');
                    pileElement.setAttribute('aria-label', `Cọc ${pileIndex + 1} với ${pile.length} biểu tượng`);
                    
                    // Add keyboard support
                    pileElement.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.selectPile(pileIndex);
                        }
                    });
                    
                    const titleElement = document.createElement('div');
                    titleElement.className = 'pile-title';
                    titleElement.textContent = `✨ Cọc ${['Thứ Nhất', 'Thứ Hai', 'Thứ Ba'][pileIndex]} ✨`;
                    pileElement.appendChild(titleElement);
                    
                    const symbolsContainer = document.createElement('div');
                    symbolsContainer.className = 'pile-cards';
                    symbolsContainer.setAttribute('role', 'group');
                    symbolsContainer.setAttribute('aria-label', `Biểu tượng trong cọc ${pileIndex + 1}`);
                    
                    pile.forEach((symbol, symbolIndex) => {
                        const symbolElement = this.createSymbolElement(symbol, symbolIndex);
                        symbolElement.style.animationDelay = `${(pileIndex * 0.4) + (symbolIndex * 0.12)}s`;
                        symbolsContainer.appendChild(symbolElement);
                    });
                    
                    pileElement.appendChild(symbolsContainer);
                    container.appendChild(pileElement);
                    
                    // Add enhanced sparkle effects
                    this.addEnhancedSparkles(pileElement, 4);
                });
            }

            addEnhancedSparkles(element, count) {
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const sparkle = document.createElement('div');
                        sparkle.className = 'sparkle';
                        sparkle.style.left = Math.random() * 100 + '%';
                        sparkle.style.top = Math.random() * 100 + '%';
                        sparkle.style.animationDelay = Math.random() * 4 + 's';
                        sparkle.setAttribute('aria-hidden', 'true');
                        element.appendChild(sparkle);
                        
                        setTimeout(() => {
                            if (sparkle.parentNode) {
                                sparkle.parentNode.removeChild(sparkle);
                            }
                        }, 5000);
                    }, i * 700);
                }
            }

            selectPile(pileIndex) {
                if (this.isAnimating) return;
                
                // Remove previous selections
                document.querySelectorAll('.card-pile').forEach((pile, index) => {
                    pile.classList.remove('selected');
                    pile.setAttribute('aria-selected', 'false');
                });
                
                // Select current pile
                const selectedPile = document.querySelectorAll('.card-pile')[pileIndex];
                selectedPile.classList.add('selected');
                selectedPile.setAttribute('aria-selected', 'true');
                this.selectedPiles[this.currentRound] = pileIndex;
                
                // Add enhanced sparkle effects
                this.addEnhancedSparkles(selectedPile, 8);
                
                // Enable next button
                const nextBtn = document.getElementById('next-btn');
                nextBtn.disabled = false;
                nextBtn.textContent = this.currentRound < 2 ? '➡️ Tiếp Theo' : '🔮 Chuẩn Bị Phép Màu';
                
                // Haptic feedback for mobile
                if ('vibrate' in navigator) {
                    navigator.vibrate(50);
                }
                
                this.announceToScreenReader(`Đã chọn cọc ${pileIndex + 1}`);
                this.updateDebugPanel();
            }

            nextRound() {
                if (this.selectedPiles[this.currentRound] === undefined) {
                    this.showEnhancedNotification('Vui lòng chọn một cọc biểu tượng trước khi tiếp tục!', 'warning');
                    this.announceToScreenReader('Vui lòng chọn một cọc trước khi tiếp tục');
                    return;
                }
                
                if (this.isAnimating) return;
                this.isAnimating = true;

                // LOGIC CHÍNH XÁC: Sắp xếp lại cards theo thứ tự đúng
                const selectedPileIndex = this.selectedPiles[this.currentRound];
                const newOrder = [];
                
                // Thứ tự đúng: pile không chọn đầu + pile chọn (giữa) + pile không chọn cuối
                const nonSelectedPiles = [];
                for (let i = 0; i < 3; i++) {
                    if (i !== selectedPileIndex) {
                        nonSelectedPiles.push(i);
                    }
                }
                
                // CRITICAL: Thứ tự sắp xếp đúng theo thuật toán
                newOrder.push(...this.currentLogicalPiles[nonSelectedPiles[0]]);
                newOrder.push(...this.currentLogicalPiles[selectedPileIndex]);
                newOrder.push(...this.currentLogicalPiles[nonSelectedPiles[1]]);
                
                this.cards = newOrder;
                this.currentRound++;
                
                setTimeout(() => {
                    if (this.currentRound < 3) {
                        this.updateStepInfo(
                            `🎯 Bước ${2 + this.currentRound}: Tìm Biểu Tượng Của Bạn`,
                            `Tuyệt vời! Bây giờ hãy tìm cọc có chứa biểu tượng của bạn một lần nữa. 
                            <strong style="color: var(--warning-orange);">(Lần ${this.currentRound + 1}/3)</strong>`
                        );
                        
                        this.dividIntoThreePiles();
                        document.getElementById('next-btn').disabled = true;
                        this.announceToScreenReader(`Bước ${2 + this.currentRound}: Hãy chọn cọc có chứa biểu tượng của bạn lần ${this.currentRound + 1}`);
                    } else {
                        this.prepareReveal();
                    }
                    this.isAnimating = false;
                    this.updateDebugPanel();
                }, 800);
            }

            prepareReveal() {
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('reveal-btn').classList.remove('hidden');
                document.getElementById('piles-container').classList.add('hidden');
                
                this.updateStepInfo(
                    '🌟 Bước Cuối: Sẵn Sàng Cho Phép Màu Thần Kỳ!',
                    `Hoàn hảo! Bạn đã hoàn thành 3 lần chọn cọc. <br>
                    Bây giờ tôi sẽ sử dụng sức mạnh thần bí để <strong>đọc chính xác tâm trí</strong> của bạn 
                    và tiết lộ biểu tượng bí mật mà bạn đã chọn từ ban đầu.`
                );
                
                this.announceToScreenReader('Sẵn sàng tiết lộ kết quả phép màu');
            }

            performMagic() {
                if (this.isAnimating) return;
                this.isAnimating = true;

                document.getElementById('step-info').classList.add('hidden');
                document.getElementById('reveal-btn').classList.add('hidden');
                document.getElementById('magic-reveal').classList.remove('hidden');
                
                this.announceToScreenReader('Đang thực hiện phép màu...');
                
                // Enhanced dramatic pause
                setTimeout(() => {
                    // MAGIC MOMENT: Biểu tượng ở vị trí logic 10 (index 10) 
                    const magicSymbol = this.cards[10];
                    
                    document.getElementById('magic-reveal').classList.add('hidden');
                    document.getElementById('final-reveal').classList.remove('hidden');
                    
                    this.displayRevealedSymbol(magicSymbol);
                    this.celebrateReveal();
                    this.isAnimating = false;
                    this.updateDebugPanel();
                    
                    this.announceToScreenReader(`Phép màu hoàn thành! Biểu tượng của bạn là ${magicSymbol.symbol}`);
                }, 5000);
            }

            displayRevealedSymbol(symbol) {
                const revealedSymbolElement = document.getElementById('revealed-symbol');
                revealedSymbolElement.className = `revealed-symbol type-${symbol.category}`;
                revealedSymbolElement.textContent = symbol.symbol;
                revealedSymbolElement.setAttribute('aria-label', `Biểu tượng được tiết lộ: ${symbol.symbol}`);
                
                // Add extra celebration sparkles
                setTimeout(() => {
                    this.addEnhancedSparkles(revealedSymbolElement.parentElement, 20);
                }, 1000);
                
                // Haptic feedback for success
                if ('vibrate' in navigator) {
                    navigator.vibrate([200, 100, 200]);
                }
            }

            celebrateReveal() {
                const finalReveal = document.getElementById('final-reveal');
                
                // Create massive celebration effects
                for (let i = 0; i < 60; i++) {
                    setTimeout(() => {
                        const sparkle = document.createElement('div');
                        sparkle.className = 'sparkle';
                        sparkle.style.left = Math.random() * 100 + '%';
                        sparkle.style.top = Math.random() * 100 + '%';
                        sparkle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                        sparkle.style.width = (Math.random() * 10 + 8) + 'px';
                        sparkle.style.height = sparkle.style.width;
                        sparkle.setAttribute('aria-hidden', 'true');
                        finalReveal.appendChild(sparkle);
                        
                        setTimeout(() => {
                            if (sparkle.parentNode) {
                                sparkle.parentNode.removeChild(sparkle);
                            }
                        }, 5000);
                    }, i * 80);
                }
                
                // Show success notification
                setTimeout(() => {
                    this.showEnhancedNotification('🎉 Phép màu hoàn thành hoàn hảo! Tôi đã đọc đúng suy nghĩ của bạn!', 'success');
                }, 1500);
            }

            updateStepInfo(title, description) {
                const stepInfo = document.getElementById('step-info');
                stepInfo.innerHTML = `
                    <h2 class="step-title">⭐ ${title} ⭐</h2>
                    <div class="step-description">${description}</div>
                `;
                stepInfo.classList.remove('hidden');
                stepInfo.classList.add('fade-in');
            }

            updateDebugPanel() {
                if (!this.DEBUG) return;
                
                try {
                    document.getElementById('debug-round').textContent = this.currentRound;
                    document.getElementById('debug-selected').textContent = JSON.stringify(this.selectedPiles);
                    document.getElementById('debug-position').textContent = '10 (index 10)';
                    
                    if (this.cards.length > 0) {
                        const logicSnippet = this.cards.slice(8, 13).map((s, i) => `${i+8}:${s.symbol}`);
                        document.getElementById('debug-logic').textContent = JSON.stringify(logicSnippet);
                    }
                    
                    if (this.currentLogicalPiles && this.currentLogicalPiles.length > 0) {
                        document.getElementById('debug-pile0').textContent = 
                            JSON.stringify(this.currentLogicalPiles[0].map(s => s.symbol));
                        document.getElementById('debug-pile1').textContent = 
                            JSON.stringify(this.currentLogicalPiles[1].map(s => s.symbol));
                        document.getElementById('debug-pile2').textContent = 
                            JSON.stringify(this.currentLogicalPiles[2].map(s => s.symbol));
                    }
                } catch (error) {
                    console.warn('Debug panel update error:', error);
                }
            }

            showEnhancedNotification(message, type = 'info') {
                const colors = {
                    info: '#3B82F6',
                    warning: '#F59E0B', 
                    success: '#10B981',
                    error: '#EF4444'
                };
                
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 30px;
                    right: 30px;
                    background: linear-gradient(135deg, ${colors[type]}, ${colors[type]}dd);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 15px;
                    font-weight: 600;
                    font-size: clamp(1rem, 2.5vw, 1.2rem);
                    z-index: 4000;
                    animation: notificationSlide 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                    box-shadow: 0 15px 35px rgba(0,0,0,0.25);
                    backdrop-filter: blur(10px);
                    border: 2px solid rgba(255,255,255,0.3);
                    max-width: min(400px, 90vw);
                    word-wrap: break-word;
                `;
                notification.innerHTML = message;
                notification.setAttribute('role', 'alert');
                notification.setAttribute('aria-live', 'assertive');
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'notificationSlideOut 0.5s ease-in forwards';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 500);
                }, type === 'success' ? 6000 : 4500);
            }

            addMouseTracker() {
                // Enhanced mouse tracking for glassmorphism effects
                document.addEventListener('mousemove', (e) => {
                    const stepInfo = document.getElementById('step-info');
                    if (stepInfo && !stepInfo.classList.contains('hidden')) {
                        const rect = stepInfo.getBoundingClientRect();
                        const x = ((e.clientX - rect.left) / rect.width) * 100;
                        const y = ((e.clientY - rect.top) / rect.height) * 100;
                        stepInfo.style.setProperty('--mouse-x', x + '%');
                        stepInfo.style.setProperty('--mouse-y', y + '%');
                    }
                });
            }

            addTouchSupport() {
                // Enhanced touch support
                let touchStartTime;
                
                document.addEventListener('touchstart', (e) => {
                    touchStartTime = Date.now();
                }, { passive: true });
                
                document.addEventListener('touchend', (e) => {
                    const touchEndTime = Date.now();
                    const touchDuration = touchEndTime - touchStartTime;
                    
                    // Prevent accidental touches
                    if (touchDuration < 50) {
                        e.preventDefault();
                        return false;
                    }
                }, { passive: false });
            }

            setupIntersectionObserver() {
                // Optimize performance with Intersection Observer
                if ('IntersectionObserver' in window) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                entry.target.classList.add('fade-in');
                            }
                        });
                    }, { threshold: 0.1 });

                    // Observe key elements
                    const observeElements = [
                        '.step-info',
                        '.initial-cards', 
                        '.cards-display',
                        '.magic-reveal',
                        '.final-reveal'
                    ];
                    
                    observeElements.forEach(selector => {
                        const elements = document.querySelectorAll(selector);
                        elements.forEach(el => observer.observe(el));
                    });
                }
            }

            preloadAssets() {
                // Preload critical resources
                const link = document.createElement('link');
                link.rel = 'preload';
                link.as = 'style';
                link.href = 'https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700;800;900&display=swap';
                document.head.appendChild(link);
            }

            announceToScreenReader(message) {
                // Accessibility: Announce to screen readers
                const announcement = document.createElement('div');
                announcement.setAttribute('aria-live', 'polite');
                announcement.setAttribute('aria-atomic', 'true');
                announcement.style.cssText = 'position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;';
                announcement.textContent = message;
                document.body.appendChild(announcement);
                
                setTimeout(() => {
                    if (announcement.parentNode) {
                        announcement.parentNode.removeChild(announcement);
                    }
                }, 1000);
            }

            addEnhancedEventListeners() {
                // Enhanced keyboard shortcuts với accessibility
                document.addEventListener('keydown', (e) => {
                    // Prevent default for certain keys
                    if (['Enter', ' ', '1', '2', '3'].includes(e.key)) {
                        const activeElement = document.activeElement;
                        if (activeElement.classList.contains('card-pile') || 
                            activeElement.classList.contains('btn')) {
                            return; // Let the element handle it
                        }
                    }
                    
                    if (e.key === 'Enter') {
                        const startBtn = document.getElementById('start-btn');
                        const nextBtn = document.getElementById('next-btn');
                        const revealBtn = document.getElementById('reveal-btn');
                        
                        if (!startBtn.classList.contains('hidden')) {
                            startBtn.focus();
                            this.startGame();
                        } else if (!nextBtn.classList.contains('hidden') && !nextBtn.disabled) {
                            nextBtn.focus();
                            this.nextRound();
                        } else if (!revealBtn.classList.contains('hidden')) {
                            revealBtn.focus();
                            this.performMagic();
                        }
                    }
                    
                    // Number keys for pile selection
                    if (['1', '2', '3'].includes(e.key) && !document.getElementById('piles-container').classList.contains('hidden')) {
                        const pileIndex = parseInt(e.key) - 1;
                        const piles = document.querySelectorAll('.card-pile');
                        if (piles[pileIndex]) {
                            piles[pileIndex].focus();
                            this.selectPile(pileIndex);
                        }
                    }
                    
                    // Debug toggle
                    if (e.key === 'D' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        this.toggleDebug();
                    }
                    
                    // Escape key to reset
                    if (e.key === 'Escape') {
                        if (confirm('Bạn có muốn bắt đầu lại không?')) {
                            restartGame();
                        }
                    }
                });

                // Enhanced window resize handler with debouncing
                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        this.handleResize();
                        this.createEnhancedParticles(); // Recreate particles for new screen size
                    }, 250);
                });

                // Enhanced visibility change handler
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        // Pause animations when tab is hidden
                        document.body.style.animationPlayState = 'paused';
                    } else {
                        // Resume animations when tab is visible
                        document.body.style.animationPlayState = 'running';
                    }
                });

                // Enhanced focus management
                document.addEventListener('focusin', (e) => {
                    if (e.target.classList.contains('card-pile')) {
                        e.target.style.outline = '3px solid rgba(255, 215, 0, 0.8)';
                        e.target.style.outlineOffset = '2px';
                    }
                });

                document.addEventListener('focusout', (e) => {
                    if (e.target.classList.contains('card-pile')) {
                        e.target.style.outline = '';
                        e.target.style.outlineOffset = '';
                    }
                });
            }

            handleResize() {
                // Enhanced responsive adjustments
                const container = document.querySelector('.container');
                const vw = window.innerWidth;
                
                // Adjust container padding
                if (vw < 375) {
                    container.style.padding = '12px';
                } else if (vw < 768) {
                    container.style.padding = '20px';
                } else {
                    container.style.padding = '30px';
                }
                
                // Adjust particle count
                this.createEnhancedParticles();
            }

            toggleDebug() {
                this.DEBUG = !this.DEBUG;
                const debugPanel = document.getElementById('debug-panel');
                if (this.DEBUG) {
                    debugPanel.classList.add('show');
                    debugPanel.setAttribute('aria-hidden', 'false');
                    this.updateDebugPanel();
                } else {
                    debugPanel.classList.remove('show');
                    debugPanel.setAttribute('aria-hidden', 'true');
                }
            }
        }

        // Global functions for HTML onclick events
        let magicTrick;

        function startGame() {
            if (magicTrick) magicTrick.startGame();
        }

        function nextRound() {
            if (magicTrick) magicTrick.nextRound();
        }

        function performMagic() {
            if (magicTrick) magicTrick.performMagic();
        }

        function restartGame() {
            // Enhanced fade out effect before reload
            document.body.style.transition = 'all 1s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            document.body.style.opacity = '0';
            document.body.style.transform = 'scale(0.95)';
            document.body.style.filter = 'blur(5px)';
            
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        function toggleDebug() {
            if (magicTrick) {
                magicTrick.toggleDebug();
            }
        }

        // Initialize the perfect magic trick
        window.addEventListener('DOMContentLoaded', function() {
            // Enhanced loading animation
            document.body.style.opacity = '0';
            document.body.style.transform = 'scale(0.95)';
            document.body.style.filter = 'blur(5px)';
            document.body.style.transition = 'all 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            
            setTimeout(() => {
                try {
                    magicTrick = new PerfectMagicTrick();
                    document.body.style.opacity = '1';
                    document.body.style.transform = 'scale(1)';
                    document.body.style.filter = 'blur(0px)';
                } catch (error) {
                    console.error('Initialization error:', error);
                    document.body.style.opacity = '1';
                    document.body.innerHTML = '<div style="text-align: center; padding: 50px; color: white;">Đã xảy ra lỗi khi khởi tạo. Vui lòng tải lại trang.</div>';
                }
            }, 600);
        });

        // Add enhanced CSS animations
        const enhancedStyle = document.createElement('style');
        enhancedStyle.textContent = `
            @keyframes notificationSlide {
                from { 
                    opacity: 0; 
                    transform: translateX(100%) scale(0.8) rotate(5deg); 
                }
                to { 
                    opacity: 1; 
                    transform: translateX(0) scale(1) rotate(0deg); 
                }
            }
            
            @keyframes notificationSlideOut {
                from { 
                    opacity: 1; 
                    transform: translateX(0) scale(1) rotate(0deg); 
                }
                to { 
                    opacity: 0; 
                    transform: translateX(100%) scale(0.8) rotate(-5deg); 
                }
            }
        `;
        document.head.appendChild(enhancedStyle);

        // Error handling và performance monitoring
        window.addEventListener('error', function(e) {
            console.error('Runtime error:', e.error);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });

        // Service worker for offline support (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Register service worker if available
                // navigator.serviceWorker.register('/sw.js').catch(console.log);
            });
        }
    </script>
</body>
</html>
